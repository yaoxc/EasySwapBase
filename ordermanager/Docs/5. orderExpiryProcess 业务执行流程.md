
# orderExpiryProcess 业务执行流程详细分析

## 1. 初始化阶段

### 1.1 错误恢复机制
```go
defer func() {
    if r := recover(); r != nil {
        xzap.WithContext(om.Ctx).Error("[Order Manage] dq process recovered: " + fmt.Sprintf("%v", r))
    }
}()
```
- 使用defer recover捕获可能的panic
- 防止主协程崩溃
- 记录错误日志便于追踪

### 1.2 加载活跃订单
```go
if err := om.loadOrdersToQueue(); err != nil {
    xzap.WithContext(om.Ctx).Error("[Order Manage] load orders to queue", zap.Error(err))
    return
}
```
- 启动时从数据库加载所有活跃订单
- 分类处理：
  - 已过期订单：批量更新状态
  - 未过期订单：添加到时间轮队列

## 2. 主循环阶段

### 2.1 时间轮轮询
```go
for {
    select {
    case <-time.After(time.Second * 1):
```
- 每秒执行一次检查
- 使用select实现定时触发
- 避免CPU空转

### 2.2 时间轮索引管理
```go
if om.CurrentIndex >= WheelSize {
    om.CurrentIndex = om.CurrentIndex % WheelSize
}
```
- 处理索引越界
- 通过取模实现循环
- 保持时间轮连续运行

## 3. 任务处理阶段

### 3.1 获取当前时间槽任务
```go
taskLinkHead := om.TimeWheel[om.CurrentIndex].NotifyActivities
headIndex := om.CurrentIndex
om.CurrentIndex++
```
- 获取当前时间槽的任务链表
- 保存当前索引用于后续删除
- 移动到下一个时间槽

### 3.2 遍历处理任务
```go
prev := taskLinkHead
p := taskLinkHead

for p != nil {
```
- 使用双指针遍历链表
- prev用于维护链表结构
- p用于遍历当前节点

### 3.3 任务分类处理
```go
if p.CycleCount == 0 {
    // 处理过期任务
    go func(chain string, orderId string, collectionAddr string) {
        if err := om.updateOrderState(orderId, collectionAddr); err != nil {
            xzap.WithContext(om.Ctx).Error("failed on update order status", zap.Error(err))
        }
    }(p.ChainSuffix, p.orderID, p.CollectionAddr)

    // 从链表删除节点
    if prev == p {
        om.TimeWheel[headIndex].NotifyActivities = p.Next
        prev = p.Next
        p = p.Next
    } else {
        prev.Next = p.Next
        p = p.Next
    }
} else {
    // 更新未到期任务
    p.CycleCount--
    prev = p
    p = p.Next
}
```

#### 3.3.1 过期任务处理
1. 异步更新订单状态
   - 使用goroutine避免阻塞
   - 传递必要参数
   - 错误处理和日志记录

2. 链表节点删除
   - 处理头节点情况
   - 处理中间节点情况
   - 维护链表完整性

#### 3.3.2 未到期任务处理
1. 圈数递减
   - 减少剩余循环次数
   - 保持任务在时间轮中
   - 继续等待下次检查

## 4. 关键特性

1. **并发安全**
   - 使用锁保护共享数据
   - 异步处理避免阻塞
   - 原子操作更新状态

2. **容错机制**
   - panic恢复保护
   - 错误日志记录
   - 优雅降级处理

3. **性能优化**
   - 时间轮减少定时器数量
   - 链表管理任务
   - 异步处理耗时操作

这个流程确保了订单过期的可靠处理，同时保持了系统的高性能和稳定性。